#include "resources.h"

static const struct Note openingSong[] = {
{16010, 17271, 69},
{17498, 17648, 67},
{17983, 19369, 69},
{19504, 19740, 67},
{19998, 20894, 69},
{20990, 21398, 69},
{21473, 21783, 67},
{21952, 23710, 64},
{23998, 25525, 62},
{25521, 25673, 60},
{26000, 27513, 62},
{27500, 27642, 60},
{28008, 28590, 62},
{28731, 28856, 62},
{28960, 29431, 62},
{29458, 29883, 60},
{29965, 31252, 57},
{32025, 34865, 72},
{34994, 35360, 72},
{35496, 35840, 74},
{35988, 36875, 76},
{36977, 37410, 74},
{37473, 37940, 72},
{37992, 38458, 69},
{38504, 39696, 67},
{39927, 40119, 67},
{40063, 43223, 69},
{43540, 43715, 69},
{43798, 43988, 72},
{44048, 44919, 69},
{44973, 45854, 67},
{45933, 47879, 64},
{48031, 48433, 62},
{48517, 51267, 60},
{51485, 51648, 57},
{51698, 51854, 60},
{52000, 52504, 62},
{52535, 52908, 64},
{52965, 53402, 67},
{53458, 53940, 69},
{53988, 55990, 67},
{56013, 58206, 62},
{58533, 58725, 60},
{58760, 58994, 62},
{59031, 60904, 64},
{60952, 61140, 62},
{61183, 61329, 64},
{61433, 61919, 67},
{61967, 63919, 69},
{64010, 65473, 69},
{65494, 65919, 67},
{66021, 67421, 69},
{67408, 67565, 67},
{68000, 68710, 69},
{68746, 68902, 72},
{68921, 69488, 69},
{69481, 69942, 67},
{69983, 71729, 64},
{72040, 73492, 62},
{73533, 73923, 60},
{74038, 75473, 62},
{75473, 76008, 60},
{76000, 76713, 62},
{76746, 76948, 64},
{76902, 77442, 62},
{77469, 77940, 60},
{77985, 79492, 57},
{80000, 81350, 72},
{81479, 81617, 74},
{81990, 83475, 76},
{83456, 83625, 72},
{83992, 84871, 69},
{84969, 85444, 67},
{85452, 85610, 69},
{85954, 87700, 64},
{88038, 89215, 62},
{89500, 89640, 64},
{89990, 91523, 65},
{91996, 92919, 64},
{93031, 93500, 62},
{93529, 93850, 60},
{94002, 95671, 57},
{96021, 97438, 69},
{98521, 98915, 67},
{99033, 99300, 69},
{99529, 99750, 72},
{100002, 100642, 74},
{100723, 100879, 72},
{100933, 101279, 69},
{101450, 101685, 67},
{101990, 103719, 64},
{104002, 105392, 62},
{105521, 105627, 60},
{106033, 107673, 62},
{107954, 109198, 64},
{109490, 109606, 64},
{109950, 111717, 69},
{112002, 113465, 81},
{113479, 113752, 79},
{113950, 115792, 81},
{116002, 116179, 81},
{116483, 117583, 81},
{117531, 117935, 79},
{117988, 118194, 76},
{118194, 118440, 79},
{118452, 119977, 76},
{120017, 121458, 74},
{121521, 121708, 72},
{121983, 123873, 74},
{124002, 124219, 74},
{124496, 125440, 74},
{125473, 125865, 72},
{125938, 127979, 69},
{128052, 129338, 72},
{129502, 129635, 69},
{130023, 131471, 72},
{131540, 131673, 69},
{131981, 132754, 72},
{132790, 132985, 74},
{132983, 133442, 72},
{133483, 133992, 69},
{133996, 135760, 67},
{135979, 137365, 62},
{137527, 137738, 60},
{138052, 139906, 62},
{140042, 141273, 64},
{141454, 141935, 64},
{141994, 143856, 69},
{0, 0, 0}
};

static float time;
const struct Note *nextNote;

void playTitleSong(void) __z88dk_fastcall {
    time = 0;
    nextNote = openingSong;

    ayChipSelect(0);
    aySetNoise(31);
    aySetAmplitude(1, 0x10);
    aySetMixer(1, 0, 1);
    
    ayChipSelect(1);
    aySetNoise(31);
    aySetAmplitude(1, 0x10);
    aySetMixer(1, 1, 1);
    
    ayChipSelect(2);
    aySetNoise(0);
    aySetAmplitude(1, 0x10);
    aySetMixer(1, 1, 1);
}

char debugBuf[20];

void updateTitleSong(void) __z88dk_fastcall {
    long start = nextNote->start;
    if(start == 0) {
        return;
    }

    time += 39.4491;

    if(time >= start) {
        enum NoteIndex note = nextNote->note;
        word duration = 600;

        ayChipSelect(0);
        aySetEnvelope(0, duration);
        ayPlayNote(1, note);

        duration *= 2;
        ayChipSelect(1);
        aySetEnvelope(0, duration);
        ayPlayNote(1, note);

        duration *= 2;
        ayChipSelect(2);
        aySetEnvelope(0, duration);
        ayPlayNote(1, note);

        ++nextNote;
    }
}
