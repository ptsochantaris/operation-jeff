#include "resources.h"

// Precalc'ed AY pitches for 3.5 MHz (218750 / note drequency)
word notePitches[] = {
    13379,
    12630,
    11921,
    11247,
    10619,
    10021,
    9462,
    8929,
    8426,
    7955,
    7507,
    7086,

    6690,
    6313,
    5959,
    5625,
    5309,
    5011,
    4730,
    4464,
    4214,
    3977,
    3754,
    3543,

    3344,
    3157,
    2979,
    2812,
    2654,
    2505,
    2365,
    2232,
    2107,
    1989,
    1877,
    1772,

    1672,
    1578,
    1490,
    1406,
    1327,
    1253,
    1182,
    1116,
    1053,
    994,
    939,
    886,

    836,
    789,
    745,
    703,
    664,
    626,
    591,
    558,
    527,
    497,
    469,
    443,

    418,
    395,
    372,
    352,
    332,
    313,
    296,
    279,
    263,
    249,
    235,
    221,

    209,
    197,
    186,
    176,
    166,
    157,
    148,
    140,
    132,
    124,
    117,
    111,

    105,
    99,
    93,
    88,
    83,
    78,
    74,
    70,
    66,
    62,
    59,
    55
};

static Note openingSong[] = {
    {16010, 17269, 69},
    {17496, 17648, 67},
    {17979, 19363, 69},
    {19500, 19733, 67},
    {19994, 20888, 69},
    {20983, 21390, 69},
    {21467, 21777, 67},
    {21944, 23700, 64},
    {23988, 25513, 62},
    {25508, 25660, 60},
    {25988, 27498, 62},
    {27485, 27627, 60},
    {27994, 28575, 62},
    {28715, 28840, 62},
    {28946, 29415, 62},
    {29444, 29867, 60},
    {29948, 31233, 57},
    {32004, 34823, 72},
    {34952, 35315, 72},
    {35450, 35792, 74},
    {35938, 36817, 76},
    {36919, 37348, 74},
    {37410, 37875, 72},
    {37927, 38390, 69},
    {38435, 39619, 67},
    {39846, 40038, 67},
    {39983, 43146, 69},
    {43463, 43635, 69},
    {43721, 43908, 72},
    {43971, 44854, 69},
    {44910, 45804, 67},
    {45883, 47858, 64},
    {48010, 48415, 62},
    {48500, 51263, 60},
    {51483, 51646, 57},
    {51696, 51852, 60},
    {52000, 52502, 62},
    {52533, 52904, 64},
    {52960, 53398, 67},
    {53454, 53933, 69},
    {53981, 55979, 67},
    {56002, 58190, 62},
    {58517, 58708, 60},
    {58744, 58977, 62},
    {59013, 60885, 64},
    {60933, 61121, 62},
    {61167, 61313, 64},
    {61417, 61902, 67},
    {61950, 63906, 69},
    {64000, 65465, 69},
    {65485, 65913, 67},
    {66013, 67417, 69},
    {67404, 67560, 67},
    {67998, 68704, 69},
    {68740, 68894, 72},
    {68913, 69477, 69},
    {69475, 69931, 67},
    {69973, 71713, 64},
    {72021, 73467, 62},
    {73508, 73898, 60},
    {74013, 75440, 62},
    {75440, 75973, 60},
    {75967, 76683, 62},
    {76719, 76921, 64},
    {76875, 77419, 62},
    {77446, 77921, 60},
    {77969, 79485, 57},
    {80000, 81346, 72},
    {81475, 81613, 74},
    {81985, 83469, 76},
    {83450, 83619, 72},
    {83985, 84865, 69},
    {84963, 85435, 67},
    {85444, 85602, 69},
    {85946, 87688, 64},
    {88027, 89202, 62},
    {89488, 89627, 64},
    {89977, 91508, 65},
    {91979, 92902, 64},
    {93013, 93481, 62},
    {93510, 93831, 60},
    {93983, 95650, 57},
    {96002, 97406, 69},
    {98483, 98875, 67},
    {98992, 99258, 69},
    {99483, 99704, 72},
    {99954, 100600, 74},
    {100681, 100840, 72},
    {100894, 101244, 69},
    {101417, 101654, 67},
    {101960, 103704, 64},
    {103990, 105381, 62},
    {105510, 105617, 60},
    {106025, 107665, 62},
    {107948, 109194, 64},
    {109483, 109602, 64},
    {109946, 111715, 69},
    {112000, 113452, 81},
    {113467, 113735, 79},
    {113933, 115760, 81},
    {115969, 116148, 81},
    {116450, 117554, 81},
    {117502, 117908, 79},
    {117958, 118167, 76},
    {118167, 118413, 79},
    {118425, 119954, 76},
    {119994, 121440, 74},
    {121502, 121690, 72},
    {121967, 123860, 74},
    {123990, 124206, 74},
    {124483, 125425, 74},
    {125458, 125848, 72},
    {125921, 127958, 69},
    {128029, 129317, 72},
    {129479, 129613, 69},
    {130000, 131450, 72},
    {131519, 131650, 69},
    {131958, 132731, 72},
    {132769, 132965, 74},
    {132963, 133419, 72},
    {133460, 133971, 69},
    {133975, 135740, 67},
    {135958, 137342, 62},
    {137506, 137715, 60},
    {138031, 139883, 62},
    {140019, 141225, 64},
    {141404, 141873, 64},
    {141931, 143756, 69}
};

static long time;
static byte noteIndex;
static byte inNote;
static byte updateCount;
#define NOTE_COUNT 128

void playTitleSong(void) __z88dk_fastcall {
    time = -10;
    noteIndex = 0;
    inNote = 0;
    updateCount = 0;

    for(byte ayChip = 0; ayChip != 3; ++ayChip) {
        ayChipSelect(ayChip);
        aySetMixer(0, 1, 0);
        aySetMixer(1, 1, 0);
        aySetMixer(2, 1, 0);
    }
}

void updateTitleSong(void) __z88dk_fastcall {
    if(noteIndex == NOTE_COUNT) {
        return;
    }

    time += 40;
    if(++updateCount == 21) {
        updateCount = 0;
        time += 4;
    }

    const Note *nextNote = openingSong+noteIndex;

    if(!inNote && time >= nextNote->start) {
        inNote = 1;

        NoteIndex note = nextNote->note - 12;
        word duration = 800;

        for(byte ayChip = 0; ayChip != 3; ++ayChip) {
            ayChipSelect(ayChip);
            aySetEnvelope(0, duration);
            duration *= 2;
            aySetAmplitude(1, 0x10);
            ayPlayNote(1, note);
        }
    } else if(inNote && time >= nextNote->end) {
        inNote = 0;
        ++noteIndex;
    }
}
